name: Release GNOME Extension

on:
  push:
    tags:
      - "v*"  # Matches tags like v1, v2, v3, etc.

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag format
        id: tag
        run: |
          if [[ ! "$GITHUB_REF_NAME" =~ ^v[0-9]+$ ]]; then
            echo "Invalid tag format: $GITHUB_REF_NAME. Expected format: v[integer]."
            exit 1
          fi
          echo "tag=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT

      - name: Locate extension directory
        id: extdir
        run: |
          DIR=$(find . -maxdepth 2 -name metadata.json -printf '%h\n' | head -n1)
          if [ -z "$DIR" ]; then
            echo "metadata.json not found"
            exit 1
          fi
          echo "dir=$DIR" >> $GITHUB_OUTPUT

      - name: Build extension zip
        run: |
          DIR="${{ steps.extdir.outputs.dir }}"
          UUID=$(jq -r '.uuid' "$DIR/metadata.json")
          VERSION="${GITHUB_REF_NAME}"
          cd "$DIR"
          zip -r "../${UUID}_${VERSION}.zip" . \
            -x "*.git*" \
            -x "*.github*" \
            -x "*.zip"

      - name: Check if release file exists
        id: checkfile
        run: |
          DIR="${{ steps.extdir.outputs.dir }}"
          UUID=$(jq -r '.uuid' "$DIR/metadata.json")
          VERSION="${GITHUB_REF_NAME}"
          FILE="../${UUID}_${VERSION}.zip"
          if [ -f "$FILE" ]; then
            echo "Release file $FILE already exists. Skipping release."
            exit 0
          fi

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          files: "*.zip"

name: Release GNOME Extension

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Locate extension directory
        id: extdir
        run: |
          DIR=$(find . -maxdepth 2 -name metadata.json -printf '%h\n' | head -n1)
          if [ -z "$DIR" ]; then
            echo "metadata.json not found"
            exit 1
          fi
          echo "dir=$DIR" >> $GITHUB_OUTPUT

      - name: Read previous version
        id: prev
        run: |
          FILE="${{ steps.extdir.outputs.dir }}/metadata.json"
          PREV=$(git show HEAD~1:"$FILE" 2>/dev/null | jq -r '.version' || echo "")
          echo "version=$PREV" >> $GITHUB_OUTPUT

      - name: Read current version
        id: curr
        run: |
          FILE="${{ steps.extdir.outputs.dir }}/metadata.json"
          CURR=$(jq -r '.version' "$FILE")
          echo "version=$CURR" >> $GITHUB_OUTPUT

      - name: Stop if version unchanged
        if: steps.prev.outputs.version == steps.curr.outputs.version
        run: |
          echo "Version unchanged (${{
            steps.curr.outputs.version
          }}), skipping release"
          exit 0

      - name: Build extension zip
        run: |
          DIR="${{ steps.extdir.outputs.dir }}"
          UUID=$(jq -r '.uuid' "$DIR/metadata.json")
          VERSION=$(jq -r '.version' "$DIR/metadata.json")
          cd "$DIR"
          zip -r "../${UUID}_v${VERSION}.zip" . \
            -x "*.git*" \
            -x "*.github*" \
            -x "*.zip"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.curr.outputs.version }}
          name: v${{ steps.curr.outputs.version }}
          files: "*.zip"
